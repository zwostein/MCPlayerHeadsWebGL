<html>
<head>
	<title>MC Player Head in WebGL Test</title>
	<style>
		canvas { width: 100%; height: 100% }
	</style>
</head>
<body>

<script src="https://raw.github.com/mrdoob/three.js/master/build/three.js"></script>
<script src="MCPlayerHead.js"></script>

<script>
var playerHeads = Array();
var selectableHeads = [];
var selectedHead;
var scene;
var camera;
var renderer;

function initiateUpdatePlayerList()
{
	var request = new XMLHttpRequest()
	request.onreadystatechange = function()
	{
		if( request.readyState == 4 )
		{
			if( request.status == 200 )
			{
				var playerNames = JSON.parse( request.responseText );
				updatePlayerList( playerNames );
			}
		}
	}
	request.open( "GET", "getPlayerList.php", true )
	request.send( null )
}
var initiateUpdatePlayerListInterval = setInterval( initiateUpdatePlayerList, 10000 );
initiateUpdatePlayerList();

function updatePlayerList( playerNames )
{
	selectableHeads = new Array();
	// Players to remove:
	for( var i in playerHeads )
	{
		if( playerNames.indexOf(i) < 0 )
		{
			scene.remove( playerHeads[i] );
			alert( "removed " + i );
			delete playerHeads[i];
		}
	}
	// Players to add:
	for( var i in playerNames )
	{
		if( !(playerNames[i] in playerHeads) )
		{
			playerHeads[playerNames[i]] = new PlayerHead( playerNames[i] );
			scene.add( playerHeads[playerNames[i]] );
			playerHeads[playerNames[i]].targetRotation = new THREE.Vector2( 0, 0 );
		}
	}
	var cnt = 1;
	for( var i in playerHeads )
	{
		selectableHeads.push( playerHeads[i] );
		playerHeads[i].position.x = (20/(playerNames.length+1)) * cnt - 10;
		cnt++;
	}
}

var targetRotation = new THREE.Vector2( 0, 0 );
var targetRotationOnMouseDown = new THREE.Vector2( 0, 0 );
var mouse = new THREE.Vector2( 0, 0 );
var mouseOnMouseDown = new THREE.Vector2( 0, 0 );
var windowHalf = new THREE.Vector2( window.innerWidth/2, window.innerHeight/2 );

function init()
{
	scene = new THREE.Scene();
	camera = new THREE.PerspectiveCamera( 45, window.innerWidth/window.innerHeight, 0.1, 1000 );
	renderer = new THREE.WebGLRenderer();
	renderer.setSize( window.innerWidth, window.innerHeight );
	document.body.appendChild( renderer.domElement );

	camera.position.z = 10;
	
	var directionalLight = new THREE.DirectionalLight( 0xffffff, 2.0 );
	directionalLight.position.set( 0, 1, 5 );
	scene.add( directionalLight );

	document.addEventListener( 'mousedown', onDocumentMouseDown, false );

	window.addEventListener( 'resize', onWindowResize, false );
}

function onWindowResize()
{
	windowHalf.x = window.innerWidth/2;
	windowHalf.y = window.innerHeight/2;
	camera.aspect = window.innerWidth / window.innerHeight;
	camera.updateProjectionMatrix();
	renderer.setSize( window.innerWidth, window.innerHeight );
}

function onDocumentMouseDown( event )
{
	event.preventDefault();

	mouseOnMouseDown.x = ( event.clientX / window.innerWidth ) * 2 - 1;
	mouseOnMouseDown.y = -( event.clientY / window.innerHeight ) * 2 + 1;

	var vector = new THREE.Vector3( mouseOnMouseDown.x, mouseOnMouseDown.y, 0.5 );
	var projector = new THREE.Projector();
	projector.unprojectVector( vector, camera );
	var ray = new THREE.Ray( camera.position, vector.subSelf( camera.position ).normalize() );
	var intersects = ray.intersectObjects( selectableHeads );
	if( intersects.length > 0 )
	{
		selectedHead = intersects[0].object;
	}

	document.addEventListener( 'mousemove', onDocumentMouseMove, false );
	document.addEventListener( 'mouseup', onDocumentMouseUp, false );
	document.addEventListener( 'mouseout', onDocumentMouseOut, false );

	if( selectedHead )
	{
		targetRotationOnMouseDown.x = selectedHead.targetRotation.x;
		targetRotationOnMouseDown.y = selectedHead.targetRotation.y;
	}
}

function onDocumentMouseMove( event )
{
	mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
	mouse.y = -( event.clientY / window.innerHeight ) * 2 + 1;

	if( selectedHead )
	{
		selectedHead.targetRotation.x = targetRotationOnMouseDown.x + ( mouse.x - mouseOnMouseDown.x ) * 5;
		selectedHead.targetRotation.y = targetRotationOnMouseDown.y + ( mouse.y - mouseOnMouseDown.y ) * 5;
		if( selectedHead.targetRotation.y > Math.PI/4 )
			selectedHead.targetRotation.y = Math.PI/4;
		if( selectedHead.targetRotation.y < -Math.PI/4 )
			selectedHead.targetRotation.y = -Math.PI/4;
	}
}

function onDocumentMouseUp( event )
{
	document.removeEventListener( 'mousemove', onDocumentMouseMove, false );
	document.removeEventListener( 'mouseup', onDocumentMouseUp, false );
	document.removeEventListener( 'mouseout', onDocumentMouseOut, false );
	selectedHead = null;
}

function onDocumentMouseOut( event )
{
	document.removeEventListener( 'mousemove', onDocumentMouseMove, false );
	document.removeEventListener( 'mouseup', onDocumentMouseUp, false );
	document.removeEventListener( 'mouseout', onDocumentMouseOut, false );
	selectedHead = null;
}

var lookAt = new THREE.Quaternion();
var randomLookAtOffset = new THREE.Quaternion();
function newRandomLookAt()
{
	var random = new THREE.Vector3( -Math.random()*50+25, Math.random()*50-25, -Math.random()*50-80 );
	var mat = new THREE.Matrix4();
	mat.lookAt( new THREE.Vector3(0,0,0), random, new THREE.Vector3(0,1,0) );
	randomLookAtOffset.setFromRotationMatrix( mat );
	randomLookAtTimeout = setTimeout( newRandomLookAt, (Math.random()*7000)+1000 );
}
var randomLookAtTimeout = setTimeout( newRandomLookAt, (Math.random()*7000)+1000 );
newRandomLookAt();

function render()
{
	requestAnimationFrame( render );

	for( var i in playerHeads )
	{
		playerHeads[i].useQuaternion = true;
		var rot = new THREE.Matrix4();
		rot.rotateY( playerHeads[i].targetRotation.x );
		rot.rotateX( -playerHeads[i].targetRotation.y );
		lookAt.setFromRotationMatrix( rot );
		lookAt.multiplySelf( randomLookAtOffset );
		var newRotation = new THREE.Quaternion();
		THREE.Quaternion.slerp( playerHeads[i].quaternion, lookAt, newRotation, 0.08 );
		playerHeads[i].quaternion = newRotation;
	}
	renderer.render( scene, camera );
}

init();
render();
</script>

</body>
</html>
