<html>
<head>
	<title>MC Player Head in WebGL Test</title>
	<style>
		canvas { width: 100%; height: 100% }
	</style>
</head>
<body>

<script src="https://raw.github.com/mrdoob/three.js/master/build/three.js"></script>
<script src="MCPlayerHead.js"></script>

<script>
var scene;
var camera;
var renderer;

var targetXRotation = 0;
var targetXRotationOnMouseDown = 0;
var targetYRotation = 0;
var targetYRotationOnMouseDown = 0;
var mouseX = 0;
var mouseXOnMouseDown = 0;
var mouseY = 0;
var mouseYOnMouseDown = 0;

var windowHalfX = window.innerWidth / 2;
var windowHalfY = window.innerHeight / 2;

function init()
{
	scene = new THREE.Scene();
	camera = new THREE.PerspectiveCamera( 45, window.innerWidth/window.innerHeight, 0.1, 1000 );
	renderer = new THREE.WebGLRenderer();
	renderer.setSize( window.innerWidth, window.innerHeight );
	document.body.appendChild( renderer.domElement );

	var playername = prompt("Bitte Spielernamen eingeben", "jeb_");
	playerHead = new PlayerHead( playername );
	scene.add( playerHead );
	
	camera.position.z = 5;
	
	var directionalLight = new THREE.DirectionalLight( 0xffffff, 2.0 );
	directionalLight.position.set( 0, 1, 5 );
	scene.add( directionalLight );

	document.addEventListener( 'mousedown', onDocumentMouseDown, false );

	window.addEventListener( 'resize', onWindowResize, false );
}

function onWindowResize()
{
	windowHalfX = window.innerWidth / 2;
	windowHalfY = window.innerHeight / 2;
	camera.aspect = window.innerWidth / window.innerHeight;
	camera.updateProjectionMatrix();
	renderer.setSize( window.innerWidth, window.innerHeight );
}

function onDocumentMouseDown( event )
{
	event.preventDefault();
	document.addEventListener( 'mousemove', onDocumentMouseMove, false );
	document.addEventListener( 'mouseup', onDocumentMouseUp, false );
	document.addEventListener( 'mouseout', onDocumentMouseOut, false );
	mouseXOnMouseDown = event.clientX - windowHalfX;
	mouseYOnMouseDown = event.clientY - windowHalfY;
	targetXRotationOnMouseDown = targetXRotation;
	targetYRotationOnMouseDown = targetYRotation;
}

function onDocumentMouseMove( event )
{
	mouseX = event.clientX - windowHalfX;
	mouseY = event.clientY - windowHalfY;
	targetXRotation = targetXRotationOnMouseDown + ( mouseX - mouseXOnMouseDown ) * 0.005;
	targetYRotation = targetYRotationOnMouseDown + ( mouseY - mouseYOnMouseDown ) * 0.005;
	if( targetYRotation > Math.PI/4 )
		targetYRotation = Math.PI/4;
	if( targetYRotation < -Math.PI/4 )
		targetYRotation = -Math.PI/4;
}

function onDocumentMouseUp( event )
{
	document.removeEventListener( 'mousemove', onDocumentMouseMove, false );
	document.removeEventListener( 'mouseup', onDocumentMouseUp, false );
	document.removeEventListener( 'mouseout', onDocumentMouseOut, false );
}

function onDocumentMouseOut( event )
{
	document.removeEventListener( 'mousemove', onDocumentMouseMove, false );
	document.removeEventListener( 'mouseup', onDocumentMouseUp, false );
	document.removeEventListener( 'mouseout', onDocumentMouseOut, false );
}

var lookAt = new THREE.Quaternion();
var randomLookAtOffset = new THREE.Quaternion();
function newRandomLookAt()
{
	var random = new THREE.Vector3( -Math.random()*50+25, Math.random()*50-25, -Math.random()*50-80 );
	var mat = new THREE.Matrix4();
	mat.lookAt( new THREE.Vector3(0,0,0), random, new THREE.Vector3(0,1,0) );
	randomLookAtOffset.setFromRotationMatrix( mat );
	var randomLookAtTimeout = setTimeout( newRandomLookAt, (Math.random()*7000)+1000 );
}
var randomLookAtTimeout = setTimeout( newRandomLookAt, (Math.random()*7000)+1000 );
newRandomLookAt();

function render()
{
	requestAnimationFrame( render );

	playerHead.useQuaternion = true;
	lookAt.setFromEuler( new THREE.Vector3( targetYRotation, targetXRotation, 0 ) );
	lookAt.multiplySelf( randomLookAtOffset );
	var newRotation = new THREE.Quaternion();
	THREE.Quaternion.slerp( playerHead.quaternion, lookAt, newRotation, 0.08 );
	playerHead.quaternion = newRotation;

	renderer.render( scene, camera );
}

init();
render();
</script>

</body>
</html>
